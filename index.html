<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—É–±–ª–∏—á–Ω—ã–π –¶–∏—Ñ—Ä–æ–≤–æ–π –ù–æ—Ç–∞—Ä–∏–∞—Ç</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        input, button { margin: 10px; padding: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 10px; }
        th { background-color: lightgray; }
    </style>
</head>
<body>

    <h2>–ü—É–±–ª–∏—á–Ω—ã–π –¶–∏—Ñ—Ä–æ–≤–æ–π –ù–æ—Ç–∞—Ä–∏–∞—Ç</h2>

    <button onclick="generateKeys()">üîë –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ECDSA-–∫–ª—é—á–∏</button>
    <p id="keys"></p>

    <input type="file" id="fileInput">
    <button onclick="processDocument()">üìÑ –ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
    
    <p id="status"></p>

    <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
    <table id="transactionsTable">
        <tr>
            <th>–•–µ—à</th>
            <th>–î–∞—Ç–∞</th>
            <th>IPFS</th>
            <th>–ü–æ–¥–ø–∏—Å—å</th>
            <th>–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
        </tr>
    </table>

    <script>
        let privateKey, publicKey;

        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
        async function generateKeys() {
            const keyPair = await window.crypto.subtle.generateKey(
                { name: "ECDSA", namedCurve: "P-256" },
                true,
                ["sign", "verify"]
            );

            privateKey = keyPair.privateKey;
            publicKey = keyPair.publicKey;

            const exportedPublicKey = await window.crypto.subtle.exportKey("spki", publicKey);
            const publicKeyBase64 = btoa(String.fromCharCode(...new Uint8Array(exportedPublicKey)));

            document.getElementById("keys").innerText = `üîë –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á: ${publicKeyBase64}`;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        async function hashFile(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
        async function signData(data) {
            const encoder = new TextEncoder();
            const signature = await crypto.subtle.sign(
                { name: "ECDSA", hash: "SHA-256" },
                privateKey,
                encoder.encode(data)
            );
            return btoa(String.fromCharCode(...new Uint8Array(signature)));
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ IPFS
        async function uploadToIPFS(file) {
            const formData = new FormData();
            formData.append("file", file);
            const response = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer –í–ê–®_PINATA_JWT"
                },
                body: formData
            });
            const data = await response.json();
            return `https://ipfs.io/ipfs/${data.IpfsHash}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ GitHub
        async function updateGitHub(transaction) {
            const repo = "–í–ê–®_GITHUB_USER/–í–ê–®_REPO";
            const filePath = "transactions.json";
            const url = `https://api.github.com/repos/${repo}/contents/${filePath}`;
            const token = "–í–ê–®_GITHUB_TOKEN";

            const response = await fetch(url, {
                headers: { "Authorization": `token ${token}` }
            });

            let transactions = [];
            let sha = "";

            if (response.status === 200) {
                const data = await response.json();
                sha = data.sha;
                const content = atob(data.content);
                transactions = JSON.parse(content);
            }

            transactions.push(transaction);

            const payload = {
                message: "–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è",
                content: btoa(JSON.stringify(transactions, null, 2)),
                sha
            };

            return fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function processDocument() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");

            document.getElementById("status").innerText = "üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...";

            const fileHash = await hashFile(file);
            const ipfsLink = await uploadToIPFS(file);
            const signature = await signData(fileHash);

            const transaction = {
                hash: fileHash,
                signature,
                ipfs: ipfsLink,
                date: new Date().toISOString()
            };

            await updateGitHub(transaction);
            document.getElementById("status").innerHTML = `‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–Ω!<br>üîó <a href="${ipfsLink}" target="_blank">IPFS</a>`;
            loadTransactions();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ GitHub
        async function loadTransactions() {
            const repo = "–í–ê–®_GITHUB_USER/–í–ê–®_REPO";
            const filePath = "transactions.json";
            const url = `https://raw.githubusercontent.com/${repo}/main/${filePath}`;

            const response = await fetch(url);
            if (response.status !== 200) return;

            const transactions = await response.json();
            const table = document.getElementById("transactionsTable");

            transactions.forEach(entry => {
                let row = table.insertRow();
                row.insertCell(0).innerText = entry.hash;
                row.insertCell(1).innerText = new Date(entry.date).toLocaleString();

                let ipfsLink = document.createElement("a");
                ipfsLink.href = entry.ipfs;
                ipfsLink.innerText = "–û—Ç–∫—Ä—ã—Ç—å";
                ipfsLink.target = "_blank";
                row.insertCell(2).appendChild(ipfsLink);

                row.insertCell(3).innerText = entry.signature.slice(0, 20) + "...";

                let verifyButton = document.createElement("button");
                verifyButton.innerText = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
                verifyButton.onclick = function() {
                    alert("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞!");
                };
                row.insertCell(4).appendChild(verifyButton);
            });
        }

        loadTransactions();
    </script>
</body>
</html>
